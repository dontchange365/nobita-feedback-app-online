<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Nobita Modern Feedback</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- FontAwesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    :root {
      --main: #6a0dad;
      --main-light: #e4d9f7;
      --bg: #f6f7fb;
      --white: #fff;
      --shadow: 0 2px 24px #a68fd944;
      --glass: rgba(255,255,255,0.7);
      --border: #eae0f5;
      --success: #1abc9c;
      --danger: #e74c3c;
      --warning: #f1c40f;
      --info: #3498db;
      --gray: #999;
      --accent: linear-gradient(90deg, #6a0dad 0%, #b47ddb 100%);
    }
    html,body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', 'Montserrat', 'Arial', sans-serif;
      background: var(--bg);
      min-height: 100vh;
      color: #222;
    }
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: var(--white);
      box-shadow: var(--shadow);
      padding: 1.2em 0.8em;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 20;
    }
    header h1 {
      margin: 0;
      font-size: 1.5em;
      background: var(--accent);
      color: #fff;
      padding: 0.2em 1.2em;
      border-radius: 12px;
      letter-spacing: 1.2px;
      font-weight: 700;
      box-shadow: 0 2px 12px #b47ddb33;
      text-shadow: 0 1px 3px #b47ddb66;
    }
    .profile-area {
      display: flex;
      align-items: center;
      gap: 1em;
    }
    .avatar {
      border-radius: 50%;
      width: 41px;
      height: 41px;
      object-fit: cover;
      border: 3px solid var(--main);
      box-shadow: 0 2px 6px #b47ddb22;
      background: #fff;
      cursor: pointer;
      transition: transform .18s;
    }
    .avatar:hover { transform: scale(1.07); }
    .user-menu {
      background: var(--white);
      position: absolute;
      top: 68px;
      right: 1.2em;
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      padding: 0.6em 0;
      min-width: 160px;
      z-index: 2001;
      display: none;
      animation: fadeIn .18s;
    }
    .user-menu.active { display: block;}
    .user-menu ul {
      list-style: none;
      margin: 0; padding: 0;
    }
    .user-menu li {
      padding: 0.8em 1.2em;
      border-bottom: 1px solid var(--main-light);
      cursor: pointer;
      font-size: 1em;
      font-weight: 500;
      transition: background .13s;
      display: flex;
      align-items: center;
      gap: 0.55em;
    }
    .user-menu li:last-child { border-bottom: none;}
    .user-menu li:hover { background: var(--main-light);}
    main {
      max-width: 568px;
      margin: 2.5em auto 1.5em auto;
      background: var(--glass);
      padding: 2em 1.4em;
      border-radius: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(5px);
      border: 1.5px solid var(--border);
    }
    .section-heading {
      font-size: 2em;
      font-weight: 800;
      background: var(--accent);
      color: #fff;
      padding: 0.1em 1em;
      border-radius: 8px;
      margin: 0 0 1.6em 0;
      box-shadow: 0 2px 10px #b47ddb29;
      letter-spacing: 1px;
      text-shadow: 0 2px 8px #b47ddb33;
      text-align: center;
    }
    /* Feedback Form */
    #feedback-form-container {
      margin-bottom: 2em;
      background: var(--white);
      border-radius: 11px;
      box-shadow: 0 2px 16px #c0a8e922;
      padding: 1.5em 1.2em;
      border: 1.5px solid var(--border);
      position: relative;
    }
    #feedback-form-title {
      font-size: 1.22em;
      font-weight: 700;
      color: var(--main);
      margin-bottom: 0.9em;
      letter-spacing: 0.7px;
    }
    .input-group {
      margin-bottom: 1.1em;
    }
    .input-group label {
      display: block;
      margin-bottom: 0.32em;
      font-weight: 500;
      color:var(--main);
    }
    .input-group input, .input-group textarea {
      width: 100%;
      padding: 0.7em;
      border: 1.2px solid var(--border);
      border-radius: 6px;
      font-size: 1em;
      background: var(--main-light);
      font-family: inherit;
      transition: border .13s;
    }
    .input-group input:focus, .input-group textarea:focus { border:1.2px solid var(--main);}
    .stars {
      display: flex;
      gap: 0.18em;
      margin-bottom: 0.3em;
    }
    .star {
      font-size: 2.1em;
      cursor: pointer;
      color: #d6c5eb;
      transition: color 0.19s, transform 0.22s;
      filter: drop-shadow(0 1px 0 #b47ddb55);
      will-change: color, transform;
      animation: popIn .18s;
    }
    .star.selected,
    .star.active {
      color: #FFD700;
      text-shadow: 0 2px 8px #ffe06688;
      animation: popStar .23s;
      transform: scale(1.25) rotate(-6deg);
    }
    .star:hover { color: #efc400; transform: scale(1.25) rotate(7deg);}
    @keyframes popStar {
      0% { transform: scale(0.88);}
      70% { transform: scale(1.25) rotate(11deg);}
      100% { transform: scale(1.15) rotate(-6deg);}
    }
    @keyframes popIn {
      0% { opacity: 0; transform: scale(0.7);}
      100% { opacity: 1; transform: scale(1);}
    }
    .feedback-edit-action {
      background: var(--main-light);
      color: var(--main);
      border: none;
      border-radius: 5px;
      padding: 0.27em 0.8em;
      font-size: 0.98em;
      cursor: pointer;
      margin-left: 0.6em;
      transition: background 0.15s;
    }
    .feedback-edit-action:hover {
      background: var(--main);
      color: #fff;
    }
    #submit-feedback {
      background: var(--main);
      color: #fff;
      border: none;
      padding: 0.85em 2em;
      border-radius: 8px;
      font-size: 1.13em;
      font-weight: 600;
      cursor: pointer;
      margin-top: 0.8em;
      box-shadow: 0 2px 14px #b47ddb44;
      transition: background .15s;
      letter-spacing: 0.5px;
    }
    #submit-feedback:hover { background: #b47ddb;}
    /* Feedback Cards */
    #feedback-list-container {
      margin-top: 2em;
      min-height: 80px;
    }
    .feedback-card {
      background: var(--white);
      border-radius: 14px;
      border: 1.4px solid var(--main-light);
      box-shadow: 0 2px 18px #b47ddb1b;
      padding: 1.2em 1em 1em 1em;
      margin-bottom: 1.4em;
      position: relative;
      animation: fadeIn .3s;
      transition: box-shadow .15s, border .18s;
    }
    .feedback-card.my-feedback { border:2px solid var(--main);}
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .feedback-header {
      display: flex;
      align-items: center;
      gap: 0.7em;
      font-weight: 700;
      font-size: 1.08em;
    }
    .feedback-header .avatar {
      width: 38px; height: 38px; border-width:2px;
    }
    .feedback-header .user-name {
      color: var(--main);
      font-weight: 700;
      font-size:1.08em;
      letter-spacing: 0.3px;
      margin-right: 0.2em;
    }
    .feedback-badges {
      display: flex;
      gap: 0.6em;
      margin-left: auto;
      align-items: center;
    }
    .badge {
      padding: 0.15em 0.7em;
      border-radius: 6px;
      font-size: 0.86em;
      font-weight: 600;
      color: #fff;
      background: var(--main);
      margin-left: 0.2em;
      text-shadow: 0 1px 5px #b47ddb88;
      letter-spacing: 0.2px;
    }
    .badge.edited { background: var(--info);}
    .badge.admin-reply { background: var(--success);}
    .feedback-rating {
      color: #FFD700;
      font-size:1.19em;
      margin-left: 1em;
      letter-spacing:0.1em;
    }
    .feedback-meta {
      font-size: 0.93em;
      color: var(--gray);
      margin-bottom: 0.2em;
      margin-left: 3.2em;
    }
    .feedback-content {
      font-size: 1.13em;
      margin: 0.7em 0 0.2em 0;
      color: #2a163b;
      word-break: break-word;
    }
    .admin-reply-block {
      background: var(--main-light);
      border-radius: 8px;
      margin-top: 0.7em;
      padding: 0.7em 1em;
      font-size: 1em;
      color: #333;
      display: flex;
      gap:0.7em;
      align-items:flex-start;
      border-left: 4px solid var(--main);
      position: relative;
    }
    .admin-reply-block .fa-shield-alt {
      color: var(--success);
      margin-right: 0.4em;
      font-size:1.2em;
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 2002;
      left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(54,0,90,0.14);
      align-items: center;
      justify-content: center;
    }
    .modal.active { display: flex;}
    .modal-content {
      background: var(--white);
      margin: auto;
      padding: 2em 2em 1em 2em;
      border-radius: 13px;
      max-width: 355px;
      width: 95vw;
      position: relative;
      box-shadow: var(--shadow);
      border: 1.5px solid var(--border);
      text-align: left;
    }
    .close-modal-btn {
      position: absolute;
      top: 0.65em; right: 0.75em;
      background: none;
      border: none;
      font-size: 1.18em;
      color: #888;
      cursor: pointer;
    }
    /* Stylish Popup */
    #stylishPopupOverlay {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(54,0,90,0.15);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
    }
    #stylishPopupOverlay.active {display:flex;}
    #stylishPopupCard {
      background: var(--white);
      border-radius: 13px;
      box-shadow: 0 4px 32px #6a0dad22;
      padding: 2em 2em 1.2em 2em;
      min-width: 320px;
      max-width: 92vw;
      position: relative;
      text-align: center;
    }
    .popup-icon-area {
      font-size: 2.25em;
      margin-bottom: 0.65em;
    }
    .popup-icon-area.success { color: var(--success);}
    .popup-icon-area.error { color: var(--danger);}
    .popup-icon-area.info { color: var(--info);}
    .popup-icon-area.warning { color: var(--warning);}
    #stylishPopupTitle {
      font-weight: bold;
      font-size: 1.12em;
      margin-bottom: 0.25em;
    }
    #stylishPopupMessage {
      margin-bottom: 1.2em;
      font-size: 1em;
    }
    #stylishPopupButtonContainer {
      display: flex;
      gap: 0.7em;
      justify-content: center;
    }
    .popup-button {
      background: var(--main);
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 0.7em 1.2em;
      cursor: pointer;
      font-size: 1em;
    }
    .popup-button.secondary {
      background: var(--border);
      color: var(--main);
    }
    /* Avatar upload preview */
    .avatar-upload-container {
      text-align:center;
      margin-bottom: 1.1em;
    }
    .avatar-upload-label {
      display: block;
      margin-top: 0.6em;
      font-size: 0.98em;
      color: var(--main);
      font-weight: 500;
      cursor: pointer;
    }
    #avatar-upload-input {
      display: none;
    }
    .avatar-upload-preview {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 3px solid var(--main);
      object-fit: cover;
      margin-bottom: 0.2em;
      background: #fff;
      box-shadow: 0 2px 8px #b47ddb44;
    }
    /* Responsive */
    @media (max-width: 650px){
      main { padding: 1em 2vw;}
      .section-heading { font-size: 1.25em;}
      .modal-content { padding: 1em;}
    }
  </style>
</head>
<body>
  <header>
    <h1>Nobita Feedback</h1>
    <div class="profile-area">
      <img src="https://via.placeholder.com/41/FFFFFF/6a0dad?text=N" id="user-avatar-trigger" class="avatar" alt="User Avatar" style="display:none;">
      <span id="login-icon-trigger" title="Login" style="font-size:2em;cursor:pointer;"><i class="fa fa-user-circle"></i></span>
      <div id="userMenu" class="user-menu">
        <ul>
          <li id="menu-profile"><i class="fa fa-user"></i> Profile</li>
          <li id="menu-logout"><i class="fa fa-sign-out-alt"></i> Logout</li>
        </ul>
      </div>
    </div>
  </header>
  <main>
    <div class="section-heading">Share Your Feedback</div>
    <div id="feedback-form-container">
      <div id="feedback-form-title"><i class="fa fa-comments"></i> We value your feedback!</div>
      <form id="feedback-form">
        <div class="input-group">
          <label for="name">Your Name</label>
          <input id="name" type="text" placeholder="Enter your name">
        </div>
        <div class="input-group">
          <label for="feedback">Feedback</label>
          <textarea id="feedback" rows="3" placeholder="Write your feedback..."></textarea>
        </div>
        <div class="input-group">
          <label>Rating</label>
          <div class="stars" id="rating-stars">
            <span class="star" data-value="1">&#9733;</span>
            <span class="star" data-value="2">&#9733;</span>
            <span class="star" data-value="3">&#9733;</span>
            <span class="star" data-value="4">&#9733;</span>
            <span class="star" data-value="5">&#9733;</span>
          </div>
        </div>
        <button type="submit" id="submit-feedback">SUBMIT FEEDBACK</button>
      </form>
    </div>
    <div class="section-heading" style="font-size:1.2em;margin-top:2.2em;">Recent Feedbacks</div>
    <div id="feedback-list-container"></div>
  </main>
  <!-- Login Modal -->
  <div class="modal" id="loginModal">
    <div class="modal-content">
      <button class="close-modal-btn" onclick="closeModal('loginModal')"><i class="fa fa-times"></i></button>
      <h3 style="text-align:center;color:var(--main);">Login</h3>
      <form id="email-login-form">
        <div class="input-group">
          <label for="modal-login-email">Email</label>
          <input type="email" id="modal-login-email" required>
        </div>
        <div class="input-group">
          <label for="modal-login-password">Password</label>
          <input type="password" id="modal-login-password" required>
        </div>
        <button type="submit" style="width:100%;">Login</button>
        <div style="margin-top:0.7em;font-size:0.97em;">
          <a href="#" id="modal-forgot-password-link">Forgot password?</a>
          <span style="float:right;">
            <a href="#" id="modal-create-account-link">Sign Up</a>
          </span>
        </div>
      </form>
    </div>
  </div>
  <!-- Signup Modal -->
  <div class="modal" id="signupModal">
    <div class="modal-content">
      <button class="close-modal-btn" onclick="closeModal('signupModal')"><i class="fa fa-times"></i></button>
      <h3 style="text-align:center;color:var(--main);">Sign Up</h3>
      <form id="email-signup-form">
        <div class="input-group">
          <label for="modal-signup-name">Name</label>
          <input type="text" id="modal-signup-name" required>
        </div>
        <div class="input-group">
          <label for="modal-signup-email">Email</label>
          <input type="email" id="modal-signup-email" required>
        </div>
        <div class="input-group">
          <label for="modal-signup-password">Password</label>
          <input type="password" id="modal-signup-password" required>
        </div>
        <div class="input-group">
          <label for="modal-signup-confirm-password">Confirm Password</label>
          <input type="password" id="modal-signup-confirm-password" required>
        </div>
        <button type="submit" style="width:100%;">Sign Up</button>
        <div style="margin-top:0.6em;font-size:0.97em;">
          <a href="#" id="modal-already-account-link">Already have an account?</a>
        </div>
      </form>
    </div>
  </div>
  <!-- Forgot Password Modal -->
  <div class="modal" id="forgotPasswordModal">
    <div class="modal-content">
      <button class="close-modal-btn" onclick="closeModal('forgotPasswordModal')"><i class="fa fa-times"></i></button>
      <h3 style="text-align:center;color:var(--main);">Forgot Password</h3>
      <form id="forgot-password-form">
        <div class="input-group">
          <label for="forgot-email">Your Email</label>
          <input type="email" id="forgot-email" required>
        </div>
        <button type="submit" style="width:100%;">Send Reset Link</button>
      </form>
    </div>
  </div>
  <!-- Profile Modal -->
  <div class="modal" id="userProfileModal">
    <div class="modal-content">
      <button class="close-modal-btn" onclick="closeModal('userProfileModal')"><i class="fa fa-times"></i></button>
      <h3 style="text-align:center;color:var(--main);">Profile</h3>
      <div class="avatar-upload-container">
        <img id="profile-display-avatar" class="avatar-upload-preview" src="https://via.placeholder.com/80/FFFFFF/6a0dad?text=U">
        <label class="avatar-upload-label" for="avatar-upload-input"><i class="fa fa-camera"></i> Change Avatar</label>
        <input id="avatar-upload-input" type="file" accept="image/*">
      </div>
      <form id="profile-edit-form">
        <div class="input-group">
          <label for="profile-name">Name</label>
          <input type="text" id="profile-name">
        </div>
        <div class="input-group">
          <label for="profile-email">Email</label>
          <input type="email" id="profile-email" readonly>
        </div>
        <button type="submit" id="save-profile-changes-btn" style="width:100%;">Save Changes</button>
      </form>
    </div>
  </div>
  <!-- Stylish Popup -->
  <div id="stylishPopupOverlay">
    <div id="stylishPopupCard">
      <div id="stylishPopupIcon" class="popup-icon-area"></div>
      <div id="stylishPopupTitle"></div>
      <div id="stylishPopupMessage"></div>
      <div id="stylishPopupButtonContainer"></div>
    </div>
  </div>
  <script>
    // --- UI helpers ---
    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }
    function showStylishPopup(type, title, message, options={}) {
      const overlay = document.getElementById('stylishPopupOverlay');
      const icon = document.getElementById('stylishPopupIcon');
      const titleEl = document.getElementById('stylishPopupTitle');
      const msgEl = document.getElementById('stylishPopupMessage');
      const btns = document.getElementById('stylishPopupButtonContainer');
      icon.className = 'popup-icon-area ' + type;
      icon.innerHTML = {
        'success':'<i class="fas fa-check-circle"></i>',
        'error':'<i class="fas fa-times-circle"></i>',
        'info':'<i class="fas fa-info-circle"></i>',
        'warning':'<i class="fas fa-exclamation-triangle"></i>'
      }[type] || '';
      titleEl.textContent = title;
      msgEl.innerHTML = message;
      btns.innerHTML = '';
      let btn = document.createElement('button');
      btn.className = 'popup-button primary';
      btn.textContent = 'OK';
      btn.onclick = ()=>overlay.classList.remove('active');
      btns.appendChild(btn);
      overlay.classList.add('active');
    }
    document.getElementById('stylishPopupOverlay').onclick = e => {
      if(e.target === document.getElementById('stylishPopupOverlay')) e.target.classList.remove('active');
    };
    // --- State ---
    let currentUser = null;
    let currentRating = 0;
    let editingFeedbackId = null;
    // --- Auth UI ---
    document.getElementById('login-icon-trigger').onclick = ()=> {
      document.getElementById('loginModal').classList.add('active');
      document.getElementById('userMenu').classList.remove('active');
    };
    document.getElementById('user-avatar-trigger').onclick = e => {
      document.getElementById('userMenu').classList.toggle('active');
    };
    document.addEventListener('click', e=>{
      const menu = document.getElementById('userMenu');
      const avatar = document.getElementById('user-avatar-trigger');
      if(menu.classList.contains('active') && !avatar.contains(e.target) && !menu.contains(e.target)) menu.classList.remove('active');
    });
    document.getElementById('menu-profile').onclick = () => {
      document.getElementById('userMenu').classList.remove('active');
      document.getElementById('userProfileModal').classList.add('active');
      document.getElementById('profile-name').value = currentUser?.name || '';
      document.getElementById('profile-email').value = currentUser?.email || '';
      document.getElementById('profile-display-avatar').src = currentUser?.avatarUrl || 'https://via.placeholder.com/80/FFFFFF/6a0dad?text=U';
    };
    document.getElementById('menu-logout').onclick = () => {
      localStorage.removeItem('authToken');
      currentUser = null;
      updateUIForUser();
      showStylishPopup('info', 'Logged Out', 'You have been logged out.');
    };
    // Modal transitions
    document.getElementById('modal-create-account-link').onclick = e => {
      e.preventDefault();
      document.getElementById('loginModal').classList.remove('active');
      document.getElementById('signupModal').classList.add('active');
    };
    document.getElementById('modal-already-account-link').onclick = e => {
      e.preventDefault();
      document.getElementById('signupModal').classList.remove('active');
      document.getElementById('loginModal').classList.add('active');
    };
    document.getElementById('modal-forgot-password-link').onclick = e => {
      e.preventDefault();
      closeModal('loginModal');
      document.getElementById('forgotPasswordModal').classList.add('active');
    };
    // --- Auth API ---
    async function apiRequest(url, method, body=null, isFormData=false) {
      let headers = {};
      if(!isFormData) headers['Content-Type']='application/json';
      if(localStorage.getItem('authToken')) headers['Authorization'] = 'Bearer '+localStorage.getItem('authToken');
      let res = await fetch(url, {
        method: method,
        headers,
        body: body ? (isFormData ? body : JSON.stringify(body)) : null
      });
      let data;
      try { data = await res.json(); } catch { data = {}; }
      if(!res.ok) throw new Error(data.message || 'Server error');
      return data;
    }
    // Login
    document.getElementById('email-login-form').onsubmit = async e => {
      e.preventDefault();
      const email = document.getElementById('modal-login-email').value.trim();
      const password = document.getElementById('modal-login-password').value;
      if(!email || !password) return showStylishPopup('error', 'Error', 'Fill all fields.');
      try {
        let data = await apiRequest('/api/auth/login', 'POST', {email, password});
        localStorage.setItem('authToken', data.token);
        currentUser = data.user;
        updateUIForUser();
        closeModal('loginModal');
        showStylishPopup('success', 'Welcome', 'Logged in successfully.');
      } catch(err) { showStylishPopup('error', 'Login Failed', err.message); }
    };
    // Signup
    document.getElementById('email-signup-form').onsubmit = async e=>{
      e.preventDefault();
      const name = document.getElementById('modal-signup-name').value.trim();
      const email = document.getElementById('modal-signup-email').value.trim();
      const password = document.getElementById('modal-signup-password').value;
      const confirm = document.getElementById('modal-signup-confirm-password').value;
      if(!name || !email || !password || !confirm)
        return showStylishPopup('error', 'Error', 'Fill all fields.');
      if(password !== confirm)
        return showStylishPopup('error', 'Password Mismatch', 'Passwords do not match!');
      if(password.length < 6)
        return showStylishPopup('error', 'Weak Password', 'At least 6 characters.');
      try {
        let data = await apiRequest('/api/auth/signup', 'POST', {name, email, password});
        localStorage.setItem('authToken', data.token);
        currentUser = data.user;
        updateUIForUser();
        closeModal('signupModal');
        showStylishPopup('success', 'Welcome', 'Account created and logged in!');
      } catch(err) { showStylishPopup('error', 'Signup Failed', err.message); }
    };
    // Forgot password
    document.getElementById('forgot-password-form').onsubmit = async e=>{
      e.preventDefault();
      let email = document.getElementById('forgot-email').value.trim();
      if(!email) return showStylishPopup('error', 'Error', 'Enter your email.');
      try {
        await apiRequest('/api/auth/request-password-reset', 'POST', {email});
        closeModal('forgotPasswordModal');
        showStylishPopup('success', 'Email Sent', 'Password reset link sent (if email exists).');
      } catch(err) { showStylishPopup('error', 'Failed', err.message);}
    };
    // Profile
    document.getElementById('profile-edit-form').onsubmit = async e => {
      e.preventDefault();
      let name = document.getElementById('profile-name').value.trim();
      if(!name) return showStylishPopup('error', 'Name Required', 'Name cannot be empty.');
      try {
        let data = await apiRequest('/api/user/profile', 'PUT', {name});
        currentUser = data.user;
        updateUIForUser();
        closeModal('userProfileModal');
        showStylishPopup('success', 'Profile Updated', 'Profile updated!');
      } catch(err) { showStylishPopup('error', 'Update Failed', err.message); }
    };
    // Avatar Upload
    document.getElementById('avatar-upload-input').onchange = async function() {
      let file = this.files[0];
      if(!file) return;
      if(!file.type.startsWith('image/')) {
        showStylishPopup('error', 'Invalid File', 'Only image files allowed.');
        return;
      }
      let reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('profile-display-avatar').src = e.target.result;
      };
      reader.readAsDataURL(file);
      // Upload to server
      let formData = new FormData();
      formData.append('avatar', file);
      try {
        let data = await apiRequest('/api/user/upload-avatar', 'POST', formData, true);
        currentUser.avatarUrl = data.avatarUrl;
        updateUIForUser();
        showStylishPopup('success', 'Avatar Updated', 'Avatar changed successfully!');
      } catch(err) { showStylishPopup('error', 'Upload Failed', err.message); }
    };
    // --- Star Animation/Selection ---
    let stars = document.querySelectorAll('.star');
    stars.forEach(star=>{
      star.onclick = function() {
        currentRating = +this.dataset.value;
        updateStars();
      };
      star.onmouseover = function() {
        updateStars(+this.dataset.value);
      };
      star.onmouseout = function() {
        updateStars();
      };
    });
    function updateStars(hover=0) {
      stars.forEach(star=>{
        let value = +star.dataset.value;
        star.classList.toggle('selected', (hover? value <= hover : value <= currentRating));
      });
    }
    // --- Feedback Form ---
    document.getElementById('feedback-form').onsubmit = async e => {
      e.preventDefault();
      let name = document.getElementById('name').value.trim();
      let feedback = document.getElementById('feedback').value.trim();
      let rating = currentRating;
      if(currentUser) name = currentUser.name;
      if(!name || !feedback || !rating) return showStylishPopup('error', 'Error', 'Please fill all fields and select a rating.');
      try {
        if(editingFeedbackId) {
          // Edit mode
          await apiRequest(`/api/feedback/${editingFeedbackId}`, 'PUT', {feedback, rating});
          showStylishPopup('success', 'Feedback Updated', 'Your feedback has been updated!');
          editingFeedbackId = null;
          document.getElementById('submit-feedback').textContent = 'SUBMIT FEEDBACK';
        } else {
          await apiRequest('/api/feedback', 'POST', {feedback, rating});
          showStylishPopup('success', 'Thank you!', 'Feedback submitted!');
        }
        document.getElementById('feedback').value = '';
        currentRating = 0; updateStars();
        fetchFeedbacks();
      } catch(err) { showStylishPopup('error', 'Error', err.message); }
    };
    // --- Feedback List ---
    async function fetchFeedbacks() {
      let res = await fetch('/api/feedbacks');
      let data = await res.json();
      let container = document.getElementById('feedback-list-container');
      container.innerHTML = '';
      if(!Array.isArray(data) || data.length === 0) {
        container.innerHTML = '<p>No feedbacks yet.</p>';
        return;
      }
      data.forEach(fb=>{
        let card = document.createElement('div');
        card.className = 'feedback-card';
        if(currentUser && fb.userId && fb.userId._id === currentUser.userId) card.classList.add('my-feedback');
        card.innerHTML = `
          <div class="feedback-header">
            <img src="${fb.avatarUrl || 'https://via.placeholder.com/38/FFFFFF/6a0dad?text=U'}" class="avatar">
            <span class="user-name">${escapeHtml(fb.name)}</span>
            <span class="feedback-rating">${starHtml(fb.rating)}</span>
            <div class="feedback-badges">
              ${fb.isEdited ? '<span class="badge edited">Edited</span>' : ''}
              ${(fb.replies && fb.replies.length) ? '<span class="badge admin-reply">Admin Reply</span>' : ''}
            </div>
          </div>
          <div class="feedback-meta">${new Date(fb.timestamp).toLocaleString()}</div>
          <div class="feedback-content">${escapeHtml(fb.feedback)}</div>
          ${fb.replies && fb.replies.length ? adminReplyBlock(fb.replies) : ''}
          ${(currentUser && fb.userId && fb.userId._id === currentUser.userId) ? `<button class="feedback-edit-action" onclick="editFeedback('${fb._id}','${escapeHtml(fb.feedback).replace(/'/g,'&#39;')}',${fb.rating})">Edit</button>` : ''}
        `;
        container.appendChild(card);
      });
    }
    window.editFeedback = function(id, feedback, rating) {
      document.getElementById('feedback').value = feedback.replace(/&#39;/g,"'");
      currentRating = rating;
      updateStars();
      editingFeedbackId = id;
      document.getElementById('submit-feedback').textContent = 'UPDATE FEEDBACK';
      window.scrollTo({top:0, behavior:'smooth'});
    }
    function starHtml(r) {
      r = Math.round(r);
      return [...Array(5)].map((_,i)=> `<span class="star${i<r?' selected':''}">&#9733;</span>`).join('');
    }
    function adminReplyBlock(replies) {
      if(!replies || !replies.length) return '';
      return replies.map(reply=>`
        <div class="admin-reply-block"><i class="fa fa-shield-alt"></i>
          <div>
            <b>Admin:</b> ${escapeHtml(reply.text)}<br>
            <span style="font-size:0.93em;color:var(--gray);">at ${new Date(reply.timestamp).toLocaleString()}</span>
          </div>
        </div>
      `).join('');
    }
    function escapeHtml(str) {
      if(!str) return '';
      return str.replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[m]));
    }
    // --- User UI ---
    function updateUIForUser() {
      let isLogged = !!currentUser;
      document.getElementById('login-icon-trigger').style.display = isLogged ? 'none' : 'inline-block';
      let avatar = document.getElementById('user-avatar-trigger');
      avatar.style.display = isLogged ? 'inline-block' : 'none';
      avatar.src = currentUser?.avatarUrl || 'https://via.placeholder.com/41/FFFFFF/6a0dad?text=U';
      document.getElementById('name').disabled = isLogged;
      document.getElementById('name').value = isLogged ? currentUser.name : '';
    }
    // --- Check login (token) & fetch feedbacks ---
    async function checkLoginStatus() {
      let token = localStorage.getItem('authToken');
      if(token) {
        try {
          let data = await apiRequest('/api/auth/me', 'GET');
          currentUser = data;
        } catch {
          localStorage.removeItem('authToken');
          currentUser = null;
        }
      }
      updateUIForUser();
      fetchFeedbacks();
    }
    checkLoginStatus();
  </script>
</body>
</html>