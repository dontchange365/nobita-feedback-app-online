<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>⭐ DYNAMIC FEEDBACK SYSTEM ⭐</title>
  <style>
    /* ==== पुराना CSS वैसा का वैसा ==== */
    body { font-family:'Arial',sans-serif; background:#F0F2F5; color:#333;
      display:flex; flex-direction:column; align-items:center;
      justify-content:center; min-height:100vh; margin:0; padding:20px; }
    .container { background:#fff; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.1);
      padding:35px; width:90%; max-width:700px; text-align:center; border:1px solid #E0E0E0; }
    .feedback-item { display:flex; gap:15px; margin-bottom:18px; padding:18px;
      background:#fff; border:1px solid #EEE; border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08); transition:transform .3s; }
    .feedback-item:hover { transform:translateY(-3px); }
    .avatar { width:55px; height:55px; border-radius:50%; overflow:hidden;
      flex-shrink:0; border:2px solid #2563EB; box-shadow:0 2px 5px rgba(0,0,0,0.2);
      background:#eee; }
    .avatar img { width:100%; height:100%; object-fit:cover; }
    /* ==== बाकी CSS वही रखो ==== */
  </style>
</head>
<body>
  <div class="container">
    <h1>⭐ SHARE YOUR VALUABLE FEEDBACK ⭐</h1>
    <div class="input-group">
      <label for="name">YOUR NAME:</label>
      <input id="name" type="text" placeholder="ENTER YOUR NAME" />
    </div>
    <div class="input-group">
      <label for="feedback">YOUR FEEDBACK:</label>
      <textarea id="feedback" placeholder="SHARE YOUR THOUGHTS HERE..."></textarea>
    </div>
    <div class="input-group">
      <label>RATE YOUR EXPERIENCE:</label>
      <div class="stars" id="star-rating">
        <span class="star" data-value="1">★</span>
        <span class="star" data-value="2">★</span>
        <span class="star" data-value="3">★</span>
        <span class="star" data-value="4">★</span>
        <span class="star" data-value="5">★</span>
      </div>
      <input id="rating" type="hidden" value="0" />
    </div>
    <button id="submit-feedback">SUBMIT FEEDBACK</button>
    <div id="feedback-list-container"><h2>RECENT FEEDBACKS</h2></div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const BASE      = 'https://nobita-feedback-app-online.onrender.com';
    const POST_URL  = `${BASE}/api/feedback`;
    const FETCH_URL = `${BASE}/api/feedbacks`;

    const nameInput   = document.getElementById('name');
    const fbInput     = document.getElementById('feedback');
    const ratingInput = document.getElementById('rating');
    const submitBtn   = document.getElementById('submit-feedback');
    const listCont    = document.getElementById('feedback-list-container');
    const stars       = document.querySelectorAll('.star');
    let currentRating = 0;

    // ★ PRELOAD 100 AVATARS ★
    const animeAvatars = [];
    async function preloadAvatars() {
      for (let i = 0; i < 100; i++) {
        try {
          const res = await fetch('https://api.waifu.pics/sfw/husbando', { mode:'cors' });
          if (!res.ok) throw new Error();
          const { url } = await res.json();
          animeAvatars.push(url);
        } catch {
          i--; // retry on failure
        }
      }
      console.log('Preloaded avatars:', animeAvatars.length);
    }

    // ★ STAR UI ★
    function updateStars(r) {
      stars.forEach(s => {
        const v = +s.dataset.value;
        s.classList.toggle('selected', v <= r);
        s.classList.remove('highlighted');
      });
    }
    stars.forEach(s => {
      s.addEventListener('click', () => {
        currentRating = +s.dataset.value;
        ratingInput.value = currentRating;
        updateStars(currentRating);
      });
      s.addEventListener('mouseenter', () => {
        const hv = +s.dataset.value;
        stars.forEach(x => {
          x.classList.toggle('highlighted', +x.dataset.value <= hv);
          x.classList.remove('selected');
        });
      });
      s.addEventListener('mouseleave', () => updateStars(currentRating));
    });

    function pickRandomAvatar() {
      return animeAvatars.length
        ? animeAvatars[Math.floor(Math.random() * animeAvatars.length)]
        : 'https://via.placeholder.com/55?text=?';
    }

    // ★ FETCH & POST ★
    async function fetchAll() {
      try {
        const res = await fetch(FETCH_URL, { mode:'cors', headers:{'Accept':'application/json'} });
        if (!res.ok) throw new Error(await res.text());
        return await res.json();
      } catch(e) {
        alert(`FEEDBACK LOAD ERROR:\n${e.message}`);
        return [];
      }
    }
    async function postOne(n,f,r) {
      const res = await fetch(POST_URL, {
        method:'POST', mode:'cors',
        headers:{'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify({ name:n, feedback:f, rating:r })
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    function addItem(name, fb, rating, replies=[]) {
      const item = document.createElement('div');
      item.className = 'feedback-item';

      const av = document.createElement('div');
      av.className = 'avatar';
      const img = document.createElement('img');
      img.src = pickRandomAvatar();
      av.append(img);

      const content = document.createElement('div');
      content.innerHTML = `
        <strong>${name.toUpperCase()}</strong>
        <div class="feedback-stars">${'★'.repeat(rating)}${'☆'.repeat(5-rating)}</div>
        <p>${fb}</p>
      `;
      item.append(av, content);

      if (replies.length) {
        const rd = document.createElement('div');
        rd.className = 'replies-main-display';
        rd.innerHTML = '<h4>ADMIN REPLIES:</h4>' +
          replies.sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp))
                 .map(r=>`
                   <div class="single-reply-main">
                     <span class="reply-admin-name-main">${r.adminName}:</span>
                     ${r.text}
                     <span class="reply-timestamp-main">(${new Date(r.timestamp).toLocaleString()})</span>
                   </div>
                 `).join('');
        item.append(rd);
      }

      listCont.prepend(item);
    }

    async function renderAll() {
      listCont.innerHTML = '<h2>RECENT FEEDBACKS</h2>';
      const arr = await fetchAll();
      if (!arr.length) {
        listCont.innerHTML += `<p style="text-align:center;color:#777">ABHI TAK KOI FEEDBACK NAHI AAYA HAI!</p>`;
      } else {
        arr.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp))
           .forEach(fb=>addItem(fb.name, fb.feedback, fb.rating, fb.replies));
      }
    }

    submitBtn.addEventListener('click', async () => {
      const n = nameInput.value.trim();
      const f = fbInput.value.trim();
      const r = +ratingInput.value;
      if (!n||!f||r===0) return alert('BHAI, NAAM, FEEDBACK AUR RATING BHARNA ZAROORI HAI!');
      submitBtn.disabled = true;
      try {
        await postOne(n,f,r);
        alert('FEEDBACK SAFALTA-POORVAK JAMA KIYA GAYA!');
        nameInput.value=''; fbInput.value=''; ratingInput.value='0';
        currentRating=0; updateStars(0);
        await renderAll();
      } catch(e) {
        alert(`SUBMIT ERROR:\n${e.message}`);
      } finally {
        submitBtn.disabled = false;
      }
    });

    // Preload avatars then render feedbacks
    preloadAvatars().then(renderAll);
  });
  </script>
</body>
</html>
