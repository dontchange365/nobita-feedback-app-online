<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ðŸ”¥ NOBI FEEDBACK APP ðŸ”¥</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;500&display=swap"
    rel="stylesheet"
  />
  <style>
    /* RESET */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background: #121212;
      color: #eee;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    header {
      width: 100%;
      max-width: 900px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    header img.logo {
      height: 60px;
      cursor: pointer;
    }
    header .profile-btn {
      position: relative;
      cursor: pointer;
    }
    header .profile-btn img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid #f0f0f0;
      object-fit: cover;
    }
    header .profile-menu {
      position: absolute;
      top: 60px;
      right: 0;
      background: #222;
      border-radius: 8px;
      box-shadow: 0 0 10px #000;
      display: none;
      flex-direction: column;
      min-width: 180px;
      z-index: 1000;
    }
    header .profile-menu.active {
      display: flex;
    }
    header .profile-menu button {
      background: none;
      border: none;
      color: #eee;
      padding: 12px 20px;
      text-align: left;
      font-size: 14px;
      cursor: pointer;
      border-bottom: 1px solid #333;
      transition: background 0.3s;
    }
    header .profile-menu button:last-child {
      border-bottom: none;
    }
    header .profile-menu button:hover {
      background: #444;
    }

    /* MAIN CONTAINER */
    main {
      width: 100%;
      max-width: 900px;
      background: #222;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 20px #000;
    }

    /* LOGIN / REGISTER FORMS */
    form {
      max-width: 400px;
      margin: 0 auto 20px;
      background: #111;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #000;
    }
    form h2 {
      margin-bottom: 15px;
      text-align: center;
      font-weight: 700;
      letter-spacing: 1.2px;
      color: #ff3f3f;
    }
    form label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      color: #bbb;
    }
    form input[type='text'],
    form input[type='email'],
    form input[type='password'] {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      margin-bottom: 15px;
      background: #333;
      color: #eee;
      font-size: 15px;
    }
    form button {
      width: 100%;
      padding: 12px;
      background: #ff3f3f;
      border: none;
      border-radius: 6px;
      font-weight: 700;
      font-size: 16px;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
    }
    form button:hover {
      background: #e03838;
    }
    .toggle-link {
      margin-top: 12px;
      text-align: center;
      font-size: 14px;
      cursor: pointer;
      color: #aaa;
      user-select: none;
    }
    .toggle-link:hover {
      color: #fff;
    }
    .google-btn {
      background: #4285f4;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-weight: 700;
    }
    .google-btn:hover {
      background: #3a78d8;
    }

    /* FEEDBACK SECTION */
    #feedback-section {
      margin-top: 30px;
    }
    #feedback-section h3 {
      color: #ff3f3f;
      margin-bottom: 15px;
      text-align: center;
      letter-spacing: 1.5px;
    }
    #feedback-form textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: #333;
      color: #eee;
      font-size: 14px;
      resize: vertical;
      margin-bottom: 12px;
    }
    #feedback-form button {
      padding: 10px 20px;
      background: #ff3f3f;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.3s;
    }
    #feedback-form button:hover {
      background: #e03838;
    }

    /* Feedback list */
    #feedback-list {
      margin-top: 25px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .feedback-card {
      background: #111;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 0 10px #000;
      display: flex;
      gap: 15px;
      align-items: flex-start;
    }
    .feedback-avatar {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ff3f3f;
    }
    .feedback-content {
      flex: 1;
    }
    .feedback-user {
      font-weight: 700;
      color: #ff3f3f;
      margin-bottom: 6px;
    }
    .feedback-text {
      font-size: 14px;
      color: #ddd;
      margin-bottom: 8px;
      white-space: pre-wrap;
    }
    .feedback-edited {
      font-size: 12px;
      color: #999;
      font-style: italic;
      margin-bottom: 8px;
    }
    .feedback-replies {
      margin-top: 8px;
      background: #222;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 13px;
      color: #ccc;
    }
    .feedback-reply {
      margin-bottom: 6px;
    }

    /* Buttons */
    .btn-small {
      padding: 5px 10px;
      font-size: 13px;
      border-radius: 6px;
      cursor: pointer;
      border: none;
      font-weight: 700;
      color: white;
      background: #ff3f3f;
      transition: background 0.3s;
      margin-right: 8px;
    }
    .btn-small:hover {
      background: #e03838;
    }

    /* Profile Page */
    #profile-page {
      max-width: 500px;
      margin: 0 auto;
      background: #111;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 0 20px #000;
      display: none;
      flex-direction: column;
      gap: 20px;
    }
    #profile-page h3 {
      color: #ff3f3f;
      text-align: center;
      margin-bottom: 12px;
    }
    #profile-avatar-preview {
      display: block;
      margin: 0 auto 12px;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #ff3f3f;
      cursor: pointer;
    }
    #avatar-upload-input {
      display: none;
    }
    #profile-page label {
      cursor: pointer;
      display: block;
      text-align: center;
      color: #aaa;
      font-size: 14px;
      margin-bottom: 8px;
      user-select: none;
    }
    #profile-page button {
      background: #ff3f3f;
      color: white;
      border: none;
      padding: 10px 15px;
      font-weight: 700;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
      width: 100%;
    }
    #profile-page button:hover {
      background: #e03838;
    }

    /* Admin Panel */
    #admin-panel {
      display: none;
      max-width: 900px;
      background: #111;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 25px #000;
      margin-top: 30px;
      color: #eee;
    }
    #admin-panel h3 {
      color: #ff3f3f;
      margin-bottom: 15px;
      text-align: center;
      letter-spacing: 1.2px;
    }
    #admin-login-form {
      max-width: 350px;
      margin: 0 auto 30px;
    }
    #admin-login-form input {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: none;
      margin-bottom: 12px;
      background: #333;
      color: #eee;
      font-size: 15px;
    }
    #admin-login-form button {
      width: 100%;
      padding: 12px;
      background: #ff3f3f;
      border: none;
      border-radius: 6px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      color: white;
      transition: background 0.3s;
    }
    #admin-login-form button:hover {
      background: #e03838;
    }
    #admin-users-list,
    #admin-feedbacks-list {
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
    }
    .admin-user,
    .admin-feedback {
      background: #222;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 12px;
    }
    .admin-user-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    .admin-user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid #ff3f3f;
      object-fit: cover;
    }
    .admin-user-info {
      flex: 1;
      color: #eee;
    }
    .admin-feedback-user {
      font-weight: 700;
      color: #ff3f3f;
      margin-bottom: 6px;
    }
    .admin-feedback-text {
      font-size: 14px;
      margin-bottom: 8px;
      white-space: pre-wrap;
    }
    .admin-reply-input {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: none;
      background: #333;
      color: #eee;
      font-size: 14px;
      margin-top: 8px;
    }
    .admin-btn-reply {
      margin-top: 6px;
      padding: 6px 14px;
      background: #ff3f3f;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
      transition: background 0.3s;
    }
    .admin-btn-reply:hover {
      background: #e03838;
    }

    /* Popup Alert */
    #popup-alert {
      position: fixed;
      bottom: 25px;
      left: 50%;
      transform: translateX(-50%);
      background: #ff3f3f;
      color: white;
      padding: 14px 25px;
      border-radius: 50px;
      font-weight: 700;
      font-size: 14px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s;
      z-index: 9999;
      box-shadow: 0 0 10px #ff3f3faa;
    }
    #popup-alert.show {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://i.ibb.co/FsSs4SG/creator-avatar.png" alt="Logo" class="logo" />
    <div class="profile-btn" id="profile-btn" title="Profile Menu" tabindex="0">
      <img src="https://i.ibb.co/FsSs4SG/creator-avatar.png" alt="Profile" id="profile-avatar" />
      <div class="profile-menu" id="profile-menu">
        <button id="view-profile-btn">View Profile</button>
        <button id="logout-btn">Logout</button>
      </div>
    </div>
  </header>

  <main>
    <!-- AUTH FORMS -->
    <section id="auth-section">
      <form id="login-form">
        <h2>Login</h2>
        <label for="login-email">Email</label>
        <input type="email" id="login-email" required />
        <label for="login-password">Password</label>
        <input type="password" id="login-password" required />
        <button type="submit">Login</button>
        <button type="button" class="google-btn" id="google-login-btn">
          <img src="https://img.icons8.com/color/24/000000/google-logo.png" alt="Google" /> Login with Google
        </button>
        <div class="toggle-link" id="show-register">Don't have an account? Register</div>
        <div class="toggle-link" id="show-forgot-password">Forgot password?</div>
      </form>

      <form id="register-form" style="display:none;">
        <h2>Register</h2>
        <label for="register-name">Name</label>
        <input type="text" id="register-name" required />
        <label for="register-email">Email</label>
        <input type="email" id="register-email" required />
        <label for="register-password">Password</label>
        <input type="password" id="register-password" required />
        <button type="submit">Register</button>
        <div class="toggle-link" id="show-login">Already have account? Login</div>
      </form>

      <form id="forgot-password-form" style="display:none;">
        <h2>Reset Password</h2>
        <label for="forgot-email">Enter your registered Email</label>
        <input type="email" id="forgot-email" required />
        <button type="submit">Send Reset Link</button>
        <div class="toggle-link" id="show-login-from-forgot">Back to Login</div>
      </form>
    </section>

    <!-- PROFILE PAGE -->
    <section id="profile-page" tabindex="0">
      <h3>Your Profile</h3>
      <img
        src="https://i.ibb.co/FsSs4SG/creator-avatar.png"
        alt="Your Avatar"
        id="profile-avatar-preview"
        title="Click to change avatar"
        tabindex="0"
      />
      <input type="file" id="avatar-upload-input" accept="image/*" hidden />
      <label for="avatar-upload-input">Click avatar to upload new one</label>
      <button id="profile-back-btn">Back to Feedback</button>
    </section>

    <!-- FEEDBACK SECTION -->
    <section id="feedback-section" style="display:none;">
      <h3>Give your Feedback</h3>
      <form id="feedback-form">
        <textarea id="feedback-text" placeholder="Type your feedback here..." required></textarea>
        <button type="submit">Submit Feedback</button>
      </form>
      <div id="feedback-list"></div>
    </section>

    <!-- ADMIN PANEL -->
    <section id="admin-panel">
      <h3>Admin Panel</h3>
      <form id="admin-login-form">
        <input type="text" id="admin-username" placeholder="Admin Username" required />
        <input type="password" id="admin-password" placeholder="Admin Password" required />
        <button type="submit">Login as Admin</button>
      </form>
      <div id="admin-content" style="display:none;">
        <h4>Users</h4>
        <div id="admin-users-list"></div>
        <h4>Feedbacks</h4>
        <div id="admin-feedbacks-list"></div>
      </div>
    </section>
  </main>

  <div id="popup-alert"></div>

  <script>
    const API_BASE = 'https://nobita-feedback-app-online.onrender.com/api';

    // DOM elements
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const forgotForm = document.getElementById('forgot-password-form');
    const showRegisterLink = document.getElementById('show-register');
    const showLoginLink = document.getElementById('show-login');
    const showForgotPasswordLink = document.getElementById('show-forgot-password');
    const showLoginFromForgot = document.getElementById('show-login-from-forgot');

    const authSection = document.getElementById('auth-section');
    const feedbackSection = document.getElementById('feedback-section');
    const profilePage = document.getElementById('profile-page');
    const profileBackBtn = document.getElementById('profile-back-btn');

    const profileBtn = document.getElementById('profile-btn');
    const profileMenu = document.getElementById('profile-menu');
    const profileAvatar = document.getElementById('profile-avatar');

    const viewProfileBtn = document.getElementById('view-profile-btn');
    const logoutBtn = document.getElementById('logout-btn');

    const feedbackForm = document.getElementById('feedback-form');
    const feedbackText = document.getElementById('feedback-text');
    const feedbackList = document.getElementById('feedback-list');

    const avatarUploadInput = document.getElementById('avatar-upload-input');
    const profileAvatarPreview = document.getElementById('profile-avatar-preview');

    const adminPanel = document.getElementById('admin-panel');
    const adminLoginForm = document.getElementById('admin-login-form');
    const adminContent = document.getElementById('admin-content');
    const adminUsersList = document.getElementById('admin-users-list');
    const adminFeedbacksList = document.getElementById('admin-feedbacks-list');

    const popupAlert = document.getElementById('popup-alert');

    let authToken = null;
    let currentUser = null;
    let isAdminLoggedIn = false;
    let adminAuthHeader = null;

    // Utility: Show popup alert
    function showPopup(msg) {
      popupAlert.textContent = msg;
      popupAlert.classList.add('show');
      setTimeout(() => popupAlert.classList.remove('show'), 3500);
    }

    // Save auth token and user info
    function saveAuthData(token, user) {
      authToken = token;
      currentUser = user;
      localStorage.setItem('authToken', token);
      localStorage.setItem('currentUser', JSON.stringify(user));
      updateUIAfterLogin();
    }

    // Clear auth data
    function clearAuthData() {
      authToken = null;
      currentUser = null;
      localStorage.removeItem('authToken');
      localStorage.removeItem('currentUser');
      updateUIAfterLogout();
    }

    // Update UI after login
    function updateUIAfterLogin() {
      authSection.style.display = 'none';
      feedbackSection.style.display = 'block';
      profilePage.style.display = 'none';
      adminPanel.style.display = 'none';

      profileAvatar.src = currentUser.avatarUrl || 'https://i.ibb.co/FsSs4SG/creator-avatar.png';

      profileBtn.style.display = 'block';
      fetchFeedbacks();
    }

    // Update UI after logout
    function updateUIAfterLogout() {
      authSection.style.display = 'block';
      feedbackSection.style.display = 'none';
      profilePage.style.display = 'none';
      profileBtn.style.display = 'none';
      adminPanel.style.display = 'none';

      isAdminLoggedIn = false;
      adminAuthHeader = null;
      adminContent.style.display = 'none';
      adminLoginForm.style.display = 'block';

      profileAvatar.src = 'https://i.ibb.co/FsSs4SG/creator-avatar.png';
    }

    // Load from localStorage on page load
    function loadAuthFromStorage() {
      const token = localStorage.getItem('authToken');
      const user = JSON.parse(localStorage.getItem('currentUser'));
      if(token && user) {
        authToken = token;
        currentUser = user;
        updateUIAfterLogin();
      } else {
        updateUIAfterLogout();
      }
    }

    // Toggle profile menu
    profileBtn.addEventListener('click', () => {
      profileMenu.classList.toggle('active');
    });
    document.addEventListener('click', (e) => {
      if (!profileBtn.contains(e.target)) {
        profileMenu.classList.remove('active');
      }
    });

    // Show register form
    showRegisterLink.addEventListener('click', () => {
      loginForm.style.display = 'none';
      registerForm.style.display = 'block';
      forgotForm.style.display = 'none';
    });

    // Show login form from register
    showLoginLink.addEventListener('click', () => {
      loginForm.style.display = 'block';
      registerForm.style.display = 'none';
      forgotForm.style.display = 'none';
    });

    // Show forgot password form
    showForgotPasswordLink.addEventListener('click', () => {
      loginForm.style.display = 'none';
      registerForm.style.display = 'none';
      forgotForm.style.display = 'block';
    });

    // Show login from forgot
    showLoginFromForgot.addEventListener('click', () => {
      loginForm.style.display = 'block';
      registerForm.style.display = 'none';
      forgotForm.style.display = 'none';
    });

    // Register user
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('register-name').value.trim();
      const email = document.getElementById('register-email').value.trim();
      const password = document.getElementById('register-password').value;

      try {
        const res = await fetch(`${API_BASE}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password }),
        });
        const data = await res.json();
        if(res.ok) {
          showPopup('Registration successful! Login now.');
          showLoginLink.click();
        } else {
          showPopup(data.message || 'Registration failed');
        }
      } catch (err) {
        showPopup('Server error during registration');
      }
    });

    // Login user
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;

      try {
        const res = await fetch(`${API_BASE}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });
        const data = await res.json();
        if(res.ok) {
          saveAuthData(data.token, data.user);
          showPopup(`Welcome back, ${data.user.name}!`);
          loginForm.reset();
        } else {
          showPopup(data.message || 'Login failed');
        }
      } catch (err) {
        showPopup('Server error during login');
      }
    });

    // Google login button
    const googleLoginBtn = document.getElementById('google-login-btn');
    googleLoginBtn.addEventListener('click', () => {
      // Google One Tap or popup integration can be added here
      // For simplicity, alert user to implement later
      alert('Google login integration kaam me nahi dala, backend ready hai, frontend integration baad me karna');
    });

    // Forgot password form submit
    forgotForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('forgot-email').value.trim();

      try {
        const res = await fetch(`${API_BASE}/forgot-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email }),
        });
        const data = await res.json();
        if(res.ok) {
          showPopup('Password reset link sent to your email!');
          forgotForm.reset();
          showLoginFromForgot.click();
        } else {
          showPopup(data.message || 'Error sending reset link');
        }
      } catch (err) {
        showPopup('Server error during password reset');
      }
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
      clearAuthData();
      showPopup('Logged out successfully');
    });

    // View profile button
    viewProfileBtn.addEventListener('click', () => {
      authSection.style.display = 'none';
      feedbackSection.style.display = 'none';
      profilePage.style.display = 'flex';
      profileMenu.classList.remove('active');

      profileAvatarPreview.src = currentUser.avatarUrl || 'https://i.ibb.co/FsSs4SG/creator-avatar.png';
    });

    // Back to feedback from profile
    profileBackBtn.addEventListener('click', () => {
      profilePage.style.display = 'none';
      feedbackSection.style.display = 'block';
    });

    // Avatar upload input change
    avatarUploadInput.addEventListener('change', async () => {
      const file = avatarUploadInput.files[0];
      if(!file) return;

      const formData = new FormData();
      formData.append('avatar', file);

      try {
        const res = await fetch(`${API_BASE}/profile/avatar`, {
          method: 'POST',
          headers: { Authorization: `Bearer ${authToken}` },
          body: formData,
        });
        const data = await res.json();
        if(res.ok) {
          profileAvatarPreview.src = data.avatarUrl;
          profileAvatar.src = data.avatarUrl;
          currentUser.avatarUrl = data.avatarUrl;
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          showPopup('Avatar updated successfully!');
        } else {
          showPopup(data.message || 'Avatar upload failed');
        }
      } catch(err) {
        showPopup('Server error uploading avatar');
      }
    });

    // Click avatar preview to open file selector
    profileAvatarPreview.addEventListener('click', () => {
      avatarUploadInput.click();
    });

    // Submit feedback
    feedbackForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = feedbackText.value.trim();
      if(!text) {
        showPopup('Feedback likh bhenchod!');
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/feedback`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${authToken}`
          },
          body: JSON.stringify({ text }),
        });
        const data = await res.json();
        if(res.ok) {
          showPopup('Feedback submit ho gaya!');
          feedbackText.value = '';
          fetchFeedbacks();
        } else {
          showPopup(data.message || 'Feedback submit failed');
        }
      } catch(err) {
        showPopup('Server error submitting feedback');
      }
    });

    // Fetch feedbacks and render
    async function fetchFeedbacks() {
      try {
        const res = await fetch(`${API_BASE}/feedback`, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        const data = await res.json();
        if(res.ok) {
          renderFeedbacks(data);
        } else {
          showPopup('Failed to load feedbacks');
        }
      } catch(err) {
        showPopup('Server error loading feedbacks');
      }
    }

    // Render feedbacks list
    function renderFeedbacks(feedbacks) {
      feedbackList.innerHTML = '';
      if(feedbacks.length === 0) {
        feedbackList.innerHTML = '<p>No feedback yet. Be first!</p>';
        return;
      }
      feedbacks.forEach(fb => {
        const card = document.createElement('div');
        card.className = 'feedback-card';

        const avatar = document.createElement('img');
        avatar.src = currentUser.avatarUrl || 'https://i.ibb.co/FsSs4SG/creator-avatar.png';
        avatar.className = 'feedback-avatar';

        const content = document.createElement('div');
        content.className = 'feedback-content';

        const userName = document.createElement('div');
        userName.className = 'feedback-user';
        userName.textContent = currentUser.name;

        const originalText = document.createElement('div');
        originalText.className = 'feedback-text';
        originalText.textContent = `Original: ${fb.originalText}`;

        const editedText = document.createElement('div');
        editedText.className = 'feedback-edited';
        editedText.textContent = fb.editedText !== fb.originalText ? `Edited: ${fb.editedText}` : '';

        // Edit & Delete buttons
        const editBtn = document.createElement('button');
        editBtn.className = 'btn-small';
        editBtn.textContent = 'Edit';
        editBtn.onclick = () => editFeedback(fb);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-small';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteFeedback(fb._id);

        content.appendChild(userName);
        content.appendChild(originalText);
        if(editedText.textContent) content.appendChild(editedText);
        content.appendChild(editBtn);
        content.appendChild(deleteBtn);

        card.appendChild(avatar);
        card.appendChild(content);

        feedbackList.appendChild(card);
      });
    }

    // Edit feedback popup prompt
    async function editFeedback(feedback) {
      const newText = prompt('Naya feedback likh:', feedback.editedText);
      if(newText && newText.trim() && newText.trim() !== feedback.editedText) {
        try {
          const res = await fetch(`${API_BASE}/feedback/${feedback._id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${authToken}`
            },
            body: JSON.stringify({ editedText: newText.trim() }),
          });
          if(res.ok) {
            showPopup('Feedback update ho gaya!');
            fetchFeedbacks();
          } else {
            showPopup('Update failed');
          }
        } catch(err) {
          showPopup('Server error updating feedback');
        }
      }
    }

    // Delete feedback confirmation
    async function deleteFeedback(id) {
      if(confirm('Delete karna hai feedback? Soch le, baad me nahi milega!')) {
        try {
          const res = await fetch(`${API_BASE}/feedback/${id}`, {
            method: 'DELETE',
            headers: { Authorization: `Bearer ${authToken}` }
          });
          if(res.ok) {
            showPopup('Feedback delete ho gaya!');
            fetchFeedbacks();
          } else {
            showPopup('Delete failed');
          }
        } catch(err) {
          showPopup('Server error deleting feedback');
        }
      }
    }

    // Admin login
    adminLoginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('admin-username').value.trim();
      const password = document.getElementById('admin-password').value.trim();

      if(!username || !password) {
        showPopup('Admin username/password de bhai!');
        return;
      }
      // Prepare Basic Auth header
      adminAuthHeader = 'Basic ' + btoa(username + ':' + password);

      // Try fetching users to test auth
      try {
        const res = await fetch(`${API_BASE}/admin/users`, {
          headers: { Authorization: adminAuthHeader }
        });
        if(res.ok) {
          isAdminLoggedIn = true;
          adminLoginForm.style.display = 'none';
          adminContent.style.display = 'block';
          fetchAdminUsers();
          fetchAdminFeedbacks();
          showPopup('Admin login successful!');
        } else {
          showPopup('Admin login failed');
        }
      } catch(err) {
        showPopup('Server error during admin login');
      }
    });

    // Fetch admin users
    async function fetchAdminUsers() {
      try {
        const res = await fetch(`${API_BASE}/admin/users`, {
          headers: { Authorization: adminAuthHeader }
        });
        const data = await res.json();
        if(res.ok) {
          renderAdminUsers(data);
        }
      } catch(err) {
        showPopup('Failed to load admin users');
      }
    }

    // Render admin users
    function renderAdminUsers(users) {
      adminUsersList.innerHTML = '';
      users.forEach(user => {
        const div = document.createElement('div');
        div.className = 'admin-user';

        const header = document.createElement('div');
        header.className = 'admin-user-header';

        const avatar = document.createElement('img');
        avatar.className = 'admin-user-avatar';
        avatar.src = user.avatarUrl || 'https://i.ibb.co/FsSs4SG/creator-avatar.png';

        const info = document.createElement('div');
        info.className = 'admin-user-info';
        info.innerHTML = `<b>${user.name}</b><br/><small>${user.email}</small>`;

        header.appendChild(avatar);
        header.appendChild(info);

        // Avatar URL input + button to update avatar
        const avatarInput = document.createElement('input');
        avatarInput.type = 'text';
        avatarInput.placeholder = 'New Avatar URL';
        avatarInput.style.width = 'calc(100% - 110px)';
        avatarInput.style.marginTop = '8px';
        avatarInput.value = user.avatarUrl || '';

        const updateBtn = document.createElement('button');
        updateBtn.textContent = 'Update Avatar';
        updateBtn.className = 'admin-btn-reply';
        updateBtn.style.width = '100px';
        updateBtn.onclick = async () => {
          if (!avatarInput.value.trim()) {
            showPopup('Avatar URL daal bhai!');
            return;
          }
          try {
            const res = await fetch(`${API_BASE}/admin/users/${user._id}/avatar`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                Authorization: adminAuthHeader
              },
              body: JSON.stringify({ avatarUrl: avatarInput.value.trim() })
            });
            if(res.ok) {
              showPopup('Avatar update ho gaya user ka!');
              fetchAdminUsers();
            } else {
              showPopup('Avatar update failed');
            }
          } catch(err) {
            showPopup('Server error avatar update');
          }
        };

        div.appendChild(header);
        div.appendChild(avatarInput);
        div.appendChild(updateBtn);

        adminUsersList.appendChild(div);
      });
    }

    // Fetch admin feedbacks
    async function fetchAdminFeedbacks() {
      try {
        const res = await fetch(`${API_BASE}/admin/feedbacks`, {
          headers: { Authorization: adminAuthHeader }
        });
        const data = await res.json();
        if(res.ok) {
          renderAdminFeedbacks(data);
        }
      } catch(err) {
        showPopup('Failed to load admin feedbacks');
      }
    }

    // Render admin feedbacks
    function renderAdminFeedbacks(feedbacks) {
      adminFeedbacksList.innerHTML = '';
      feedbacks.forEach(fb => {
        const div = document.createElement('div');
        div.className = 'admin-feedback';

        const userName = document.createElement('div');
        userName.className = 'admin-feedback-user';
        userName.textContent = fb.user?.name || 'Unknown';

        const fbText = document.createElement('div');
        fbText.className = 'admin-feedback-text';
        fbText.textContent = `Original: ${fb.originalText}\nEdited: ${fb.editedText || fb.originalText}`;

        div.appendChild(userName);
        div.appendChild(fbText);

        // Replies list
        if(fb.replies?.length > 0) {
          const repliesDiv = document.createElement('div');
          repliesDiv.className = 'feedback-replies';
          fb.replies.forEach(r => {
            const rDiv = document.createElement('div');
            rDiv.className = 'feedback-reply';
            rDiv.textContent = r.text;
            repliesDiv.appendChild(rDiv);
          });
          div.appendChild(repliesDiv);
        }

        // Reply input & button
        const replyInput = document.createElement('textarea');
        replyInput.className = 'admin-reply-input';
        replyInput.rows = 2;
        replyInput.placeholder = 'Type reply here...';

        const replyBtn = document.createElement('button');
        replyBtn.className = 'admin-btn-reply';
        replyBtn.textContent = 'Reply';
        replyBtn.onclick = async () => {
          const replyText = replyInput.value.trim();
          if(!replyText) {
            showPopup('Reply likh bhenchod!');
            return;
          }
          try {
            const res = await fetch(`${API_BASE}/admin/feedbacks/${fb._id}/reply`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: adminAuthHeader
              },
              body: JSON.stringify({ text: replyText })
            });
            if(res.ok) {
              showPopup('Reply add ho gaya!');
              replyInput.value = '';
              fetchAdminFeedbacks();
            } else {
              showPopup('Reply failed');
            }
          } catch(err) {
            showPopup('Server error sending reply');
          }
        };

        div.appendChild(replyInput);
        div.appendChild(replyBtn);

        adminFeedbacksList.appendChild(div);
      });
    }

    // INITIAL LOAD
    loadAuthFromStorage();
  </script>
</body>
</html>
